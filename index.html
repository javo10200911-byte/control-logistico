<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üöõ Control de Cargue y Descargue</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#0f2a44;
  --secondary:#16a34a;
  --danger:#dc2626;
  --bg:#f4f6fa;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:'Inter','Segoe UI',sans-serif;
}

body{
  background:var(--bg);
  padding:24px;
  color:var(--text);
}

.header{
  background:linear-gradient(135deg,#0f2a44,#123c66);
  color:#fff;
  padding:22px 28px;
  border-radius:14px;
  margin-bottom:24px;
  box-shadow:0 10px 30px rgba(0,0,0,.12);
}

.header h1{
  font-size:22px;
  font-weight:700;
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:22px;
  margin-bottom:24px;
  box-shadow:0 8px 26px rgba(0,0,0,.06);
}

.card h2{
  font-size:16px;
  margin-bottom:14px;
  font-weight:600;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
}

input, select, textarea{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:13px;
  background:#fff;
  text-transform:uppercase;
}

input[type="date"],
input[type="time"]{
  text-transform:none;
}

textarea{
  resize:vertical;
  min-height:32px;
}

input:focus, select:focus, textarea:focus{
  outline:none;
  border-color:var(--secondary);
  box-shadow:0 0 0 2px rgba(22,163,74,.15);
}

.buttons{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:16px;
}

button{
  background:var(--secondary);
  border:none;
  color:#fff;
  padding:11px 16px;
  border-radius:10px;
  font-weight:600;
  font-size:13px;
  cursor:pointer;
  transition:.2s;
}

button:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(0,0,0,.15);
}

button.secondary{
  background:#2563eb;
}

.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;
  margin-bottom:24px;
}

.dashboard-card{
  background:#111827;
  color:#fff;
  padding:18px;
  border-radius:14px;
  text-align:center;
}

.dashboard-card h4{
  font-size:13px;
  font-weight:500;
  color:#d1d5db;
}

.dashboard-card span{
  display:block;
  margin-top:6px;
  font-size:18px;
  font-weight:700;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

thead{
  background:var(--primary);
  color:#fff;
  position:sticky;
  top:0;
  z-index:2;
}

th,td{
  padding:8px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

tbody tr:hover{
  background:#f9fafb;
}

.btn-delete{
  background:var(--danger);
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="header">
  <h1>üöõ Sistema de Control Log√≠stico</h1>
</div>

<div class="card">
<h2>üìù Registro de operaci√≥n</h2>

<div class="grid">
  <input id="fecha" type="date">
  <input id="transportadora" placeholder="Transportadora">
  <input id="conductor" placeholder="Conductor">
  <input id="placa" placeholder="Placa">
  <input id="producto" placeholder="Producto">
  <select id="operacion">
    <option value="">Operaci√≥n</option>
    <option>CARGUE</option>
    <option>DESCARGUE</option>
  </select>
  <input id="inicio" type="time">
  <input id="muelle" placeholder="Muelle">
  <input id="responsable" placeholder="Responsable">
</div>

<div class="buttons">
  <button onclick="registrar()">üíæ Guardar</button>
  <button class="secondary" onclick="exportarExcel()">üì• Excel</button>
  <button class="secondary" onclick="abrirDashboard()">üìä Dashboard</button>
</div>
</div>

<div class="dashboard">
  <div class="dashboard-card"><h4>Total registros</h4><span id="m-total">0</span></div>
  <div class="dashboard-card"><h4>Tiempo promedio</h4><span id="m-promedio">--</span></div>
  <div class="dashboard-card"><h4>Tiempo m√°ximo</h4><span id="m-max">--</span></div>
  <div class="dashboard-card"><h4>Tiempo m√≠nimo</h4><span id="m-min">--</span></div>
</div>

<div class="card">
<h2>üìã Historial de operaciones</h2>

<table>
<thead>
<tr>
<th>#</th><th>Fecha</th><th>Transportadora</th><th>Conductor</th>
<th>Placa</th><th>Producto</th><th>Operaci√≥n</th>
<th>Inicio</th><th>Fin</th><th>Tiempo</th>
<th>Muelle</th><th>Responsable</th>
<th>Observaciones</th><th></th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<!-- TU SCRIPT ORIGINAL SIN CAMBIOS -->
<script>
const API_URL="https://script.google.com/macros/s/AKfycbwaNPotmMQcXYXx1Q0muTeowOrg-fMzXO3nWwp6nKOPfokgCAJQLOrZPX86JCzVFycx/exec";
let datosOriginales=[];
let debounceTimers={};
let editandoObservaciones=false;
let contentidoTextareas={};

function cargar(){
 if(editandoObservaciones) return; // No recargar si est√° escribiendo en observaciones
 fetch(API_URL).then(r=>r.json()).then(data=>{
   datosOriginales=data;
   renderTabla(data);
   actualizarDashboard(data);
 });
}

function calcularTiempo(inicio, fin) {
  if (!inicio || !fin) return "00 HH 00 MM 00 SS";
  
  try {
    const [h1, m1] = inicio.split(':').map(Number);
    const [h2, m2] = fin.split(':').map(Number);
    
    if (isNaN(h1) || isNaN(m1) || isNaN(h2) || isNaN(m2)) {
      return "00 HH 00 MM 00 SS";
    }
    
    const minInicio = h1 * 60 + m1;
    const minFin = h2 * 60 + m2;
    let minDif = minFin - minInicio;
    
    if (minDif < 0) minDif += 24 * 60;
    
    const h = Math.floor(minDif / 60);
    const m = minDif % 60;
    const s = 0;
    
    return `${h.toString().padStart(2, "0")} HH ${m.toString().padStart(2, "0")} MM ${s.toString().padStart(2, "0")} SS`;
  } catch (e) {
    return "00 HH 00 MM 00 SS";
  }
}

function renderTabla(data){
 let html="";
 data.forEach((r,i)=>{
 const tiempoCalculado = (r.Tiempo && r.Tiempo.includes("HH")) ? r.Tiempo : calcularTiempo(r.Inicio || "", r.Fin || "");
 const finDisabled = r.Fin ? "disabled" : "";
 const obsValue = contentidoTextareas[i] !== undefined ? contentidoTextareas[i] : (r.Observaciones || "");
 html+=`
<tr>
<td>${i+1}</td>
<td>${r.Fecha||""}</td>
<td>${r.Transportadora||""}</td>
<td>${r.Conductor||""}</td>
<td>${r.Placa||""}</td>
<td>${r.Producto||""}</td>
<td>${r.Operacion||""}</td>
<td>${r.Inicio||""}</td>
<td><input id="fin-${i}" type="time" value="${r.Fin||""}" onchange="actualizarFin(${i},this.value)" ${finDisabled}></td>
<td id="tiempo-${i}">${tiempoCalculado}</td>
<td>${r.Muelle||""}</td>
<td>${r.Responsable||""}</td>
<td><textarea id="obs-${i}" style="width:100%;min-height:60px;" placeholder="Observaciones" data-index="${i}">${obsValue}</textarea></td>
<td><button class="btn-delete" onclick="eliminar(${i})">üóëÔ∏è</button></td>
</tr>`;
 });
 tabla.innerHTML=html;
 document.querySelectorAll('textarea[data-index]').forEach(ta => {
   ta.addEventListener('input', debounceObs);
 });
}

function registrar(){
 const tiempo = "";
 fetch(API_URL,{
  method:"POST",
  body:JSON.stringify({
   fecha:fecha.value,
   transportadora:transportadora.value,
   conductor:conductor.value,
   placa:placa.value,
   producto:producto.value,
   operacion:operacion.value,
   inicio:inicio.value,
   fin:"",
   tiempo:tiempo,
   muelle:muelle.value,
   responsable:responsable.value
  })
 }).then(r=>{
   if(r.ok) {
     document.querySelectorAll('input, select, textarea').forEach(el => {
       if(el.id !== 'tabla') el.value = '';
     });
   }
   return cargar();
 });
}

function actualizarFin(i,fin){
 const inicio = datosOriginales[i]?.Inicio || "";
 const tiempo = calcularTiempo(inicio, fin);
 const tiempoElem = document.getElementById("tiempo-"+i);
 const finInput = document.getElementById("fin-"+i);
 if(tiempoElem) {
   tiempoElem.textContent = tiempo;
 }
 if(finInput) {
   finInput.disabled = true;
 }
 fetch(API_URL,{
  method:"POST",
  body:JSON.stringify({action:"update",index:i,fin:fin,tiempo:tiempo})
 }).catch(e=>console.error(e));
}

function debounceObs(e) {
  editandoObservaciones = true;
  const textarea = e.target;
  const i = parseInt(textarea.getAttribute('data-index'));
  const t = textarea.value;
  
  contentidoTextareas[i] = t;
  
  clearTimeout(debounceTimers[i]);
  
  debounceTimers[i] = setTimeout(() => {
    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({action:"updateObs",index:i,observaciones:t})
    }).then(() => {
      editandoObservaciones = false;
    }).catch(e=>{
      console.error(e);
      editandoObservaciones = false;
    });
  }, 3000);
}

function eliminar(i){
 if(prompt("Clave admin")!=="Admin123")return;
 fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delete",index:i})})
 .then(cargar);
}

function actualizarDashboard(data){
  document.getElementById("m-total").innerText = data.length;

  const tiempos = data
    .map(r => {
      const tiempoCalculado = (r.Tiempo && r.Tiempo.includes("HH")) ? r.Tiempo : calcularTiempo(r.Inicio || "", r.Fin || "");
      return tiempoCalculado;
    })
    .filter(t => t && t.includes("HH"));

  if(!tiempos.length){
    document.getElementById("m-promedio").innerText="--";
    document.getElementById("m-max").innerText="--";
    document.getElementById("m-min").innerText="--";
    return;
  }

  const segundos = tiempos.map(t=>{
    const n = t.match(/\d+/g).map(Number);
    return n[0]*3600 + n[1]*60 + n[2];
  });

  const f = s => {
    const h=Math.floor(s/3600); s%=3600;
    const m=Math.floor(s/60); const ss=s%60;
    return `${h} HH ${m.toString().padStart(2,"0")} MM ${ss.toString().padStart(2,"0")} SS`;
  };

  document.getElementById("m-promedio").innerText =
    f(Math.floor(segundos.reduce((a,b)=>a+b,0)/segundos.length));
  document.getElementById("m-max").innerText = f(Math.max(...segundos));
  document.getElementById("m-min").innerText = f(Math.min(...segundos));
}

function abrirDashboard(){
  window.open("dashboard.html", "_blank");
}

function exportarExcel(){
  const datos = datosOriginales;
  const ws = XLSX.utils.json_to_sheet(datos);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Operaciones");
  XLSX.writeFile(wb, "control_logistico.xlsx");
}

window.onload=cargar;
setInterval(cargar,15000);
</script>


</body>
</html>
