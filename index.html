<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title> Registros de Cargue y Descargue</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      padding: 20px;
    }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
    }

    h2 { margin-bottom: 10px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }

    input, select, textarea, button {
      padding: 8px;
      font-size: 14px;
      width: 100%;
    }

    textarea { resize: vertical; }

    button {
      background: #2ecc71;
      color: #fff;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      background: #2c3e50;
      color: white;
      padding: 8px;
    }

    td {
      padding: 6px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
  </style>
</head>
<body>

<!-- ================= REGISTRO ================= -->
<div class="card">
  <h2> Registrar operaci贸n</h2>

  <div class="grid">
    <input id="fecha" type="date">
    <input id="transportadora" placeholder="Transportadora">
    <input id="conductor" placeholder="Conductor">
    <input id="placa" placeholder="Placa">
    <input id="producto" placeholder="Producto">

    <select id="operacion">
      <option value="">Operaci贸n</option>
      <option value="Cargue">Cargue</option>
      <option value="Descargue">Descargue</option>
    </select>

    <input id="inicio" type="time" onchange="calcularTiempo()">
    <input id="fin" type="time" onchange="calcularTiempo()">

    <input id="minutos" placeholder="Tiempo calculado" readonly>
    <input id="muelle" placeholder="Muelle">
    <input id="responsable" placeholder="Responsable">
  </div>

  <br>
  <textarea id="observaciones" placeholder="Observaciones"></textarea>
  <br><br>

  <button onclick="registrar()">Registrar</button>
</div>

<!-- ================= TABLA ================= -->
<div class="card">
  <h2> Registros</h2>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Fecha</th>
        <th>Transportadora</th>
        <th>Conductor</th>
        <th>Placa</th>
        <th>Producto</th>
        <th>Operaci贸n</th>
        <th>Inicio</th>
        <th>Fin</th>
        <th>Minutos</th>
        <th>Muelle</th>
        <th>Responsable</th>
        <th>Observaciones</th>
      </tr>
    </thead>
    <tbody id="tabla"></tbody>
  </table>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxn-v6Tc9bI-_QHAcRO6yTvGjHdnqG7vIt1neQ8LEmIlyEgtQbdcAe7_vCibeJjojPbYw/exec";

// -------- CALCULAR TIEMPO --------
function calcularTiempo() {
  const inicio = document.getElementById("inicio").value;
  const fin = document.getElementById("fin").value;
  if (!inicio || !fin) return;

  const [hi, mi] = inicio.split(":").map(Number);
  const [hf, mf] = fin.split(":").map(Number);

  let inicioSeg = hi * 3600 + mi * 60;
  let finSeg = hf * 3600 + mf * 60;

  if (finSeg < inicioSeg) return;

  let diff = finSeg - inicioSeg;

  const h = Math.floor(diff / 3600);
  diff %= 3600;
  const m = Math.floor(diff / 60);
  const s = diff % 60;

  document.getElementById("minutos").value =
    `${h} hh ${m.toString().padStart(2,"0")} mm ${s.toString().padStart(2,"0")} ss`;
}

// -------- REGISTRAR --------
function registrar() {
  const fechaInput = document.getElementById("fecha").value;
  const fecha = fechaInput ? fechaInput : new Date().toISOString().split("T")[0];

  const data = {
    fecha,
    transportadora: transportadora.value,
    conductor: conductor.value,
    placa: placa.value,
    producto: producto.value,
    operacion: operacion.value,
    inicio: inicio.value,
    fin: fin.value,
    minutos: minutos.value,
    muelle: muelle.value,
    responsable: responsable.value,
    observaciones: observaciones.value
  };

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(() => {
    limpiarFormulario();
    cargarRegistros();
    alert("Registro guardado correctamente");
  })
  .catch(() => alert("Error de conexi贸n"));
}

// -------- LIMPIAR FORMULARIO --------
function limpiarFormulario() {
  document.querySelectorAll("input, textarea, select").forEach(e => e.value = "");
}

// -------- CARGAR REGISTROS --------
function cargarRegistros() {
  fetch(API_URL)
    .then(r => r.json())
    .then(data => {
      const tbody = document.getElementById("tabla");
      tbody.innerHTML = "";

      data.forEach((r, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${i+1}</td>
            <td>${r.Fecha || ""}</td>
            <td>${r.Transportadora || ""}</td>
            <td>${r.Conductor || ""}</td>
            <td>${r.Placa || ""}</td>
            <td>${r.Producto || ""}</td>
            <td>${r.Operacion || ""}</td>
            <td>${r.Inicio || ""}</td>
          <td>
  <input type="time"
         value="${r.Fin || ""}"
         onchange="actualizarFin(${i}, this.value)">
</td>

<td id="min-${i}">
  ${r.Minutos || ""}
</td>
            <td>${r.Muelle || ""}</td>
            <td>${r.Responsable || ""}</td>
            <td>${r.Observaciones || ""}</td>
          </tr>`;
      });
    });
}
  function actualizarFin(index, nuevoFin) {
  fetch(API_URL)
    .then(r => r.json())
    .then(data => {

      const registro = data[index];
      if (!registro || !registro.Inicio) return;

      const inicio = registro.Inicio;

      // calcular tiempo
      const [hi, mi] = inicio.split(":").map(Number);
      const [hf, mf] = nuevoFin.split(":").map(Number);

      let iniSeg = hi * 3600 + mi * 60;
      let finSeg = hf * 3600 + mf * 60;

      if (finSeg < iniSeg) {
        alert("La hora fin no puede ser menor a inicio");
        return;
      }

      let diff = finSeg - iniSeg;
      const h = Math.floor(diff / 3600);
      diff %= 3600;
      const m = Math.floor(diff / 60);
      const s = diff % 60;

      const tiempo = `${h} hh ${m.toString().padStart(2,"0")} mm ${s.toString().padStart(2,"0")} ss`;

      // actualizar visual
      document.getElementById(`min-${index}`).innerText = tiempo;

      // enviar actualizaci贸n al backend
      fetch(API_URL, {
        method: "PUT",
        body: JSON.stringify({
          index,
          fin: nuevoFin,
          minutos: tiempo
        })
      });
    });
}


window.onload = cargarRegistros;
</script>

</body>
</html>

