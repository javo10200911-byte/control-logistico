<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üöõ Control de Cargue y Descargue</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#1f3a5f;
  --secondary:#2ecc71;
  --danger:#e74c3c;
  --bg:#f1f4f9;
  --card:#ffffff;
  --border:#e1e5eb;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter','Segoe UI',sans-serif;}
body{background:var(--bg);padding:20px;}

.header{
  background:var(--primary);
  color:#fff;
  padding:18px 24px;
  border-radius:10px;
  margin-bottom:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
}

h2{font-size:16px;margin-bottom:15px;color:var(--primary);}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}

input, select, textarea{
  padding:10px;
  border-radius:6px;
  border:1px solid var(--border);
  font-size:13px;
  text-transform:uppercase;
}

input[type="time"]{text-transform:none;}

button{
  margin-top:15px;
  background:var(--secondary);
  border:none;
  color:#fff;
  padding:12px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}

.table-wrapper{overflow-x:auto;}

table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

thead{background:var(--primary);color:#fff;}
th,td{
  padding:8px;
  border-bottom:1px solid var(--border);
  text-align:center;
  white-space:nowrap;
}

tbody tr:hover{background:#f7f9fc;}

.btn-delete{
  background:var(--danger);
  color:#fff;
  border:none;
  padding:6px 10px;
  border-radius:5px;
  cursor:pointer;
}

/* DASHBOARD */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  margin:20px 0;
}

.dashboard-card{
  background:#1f2937;
  color:#fff;
  padding:15px;
  border-radius:10px;
  text-align:center;
}

.dashboard-card h4{
  font-size:14px;
  opacity:.8;
}

.dashboard-card span{
  font-size:22px;
  font-weight:bold;
  margin-top:5px;
  display:block;
}
</style>
</head>

<body>

<div class="header">
  <h1>üöõ Sistema de Control Log√≠stico</h1>
 
</div>
<div class="card">
  
<!-- REGISTRO -->
<div class="card">
  <h2>üìù Registrar operaci√≥n</h2>

  <div class="grid">
    <input id="fecha" type="date">
    <input id="transportadora" placeholder="Transportadora">
    <input id="conductor" placeholder="Conductor">
    <input id="placa" placeholder="Placa">
    <input id="producto" placeholder="Producto">

    <select id="operacion">
      <option value="">Operaci√≥n</option>
      <option>CARGUE</option>
      <option>DESCARGUE</option>
    </select>

    <input id="inicio" type="time">
    <input id="fin" type="time">

    <input id="muelle" placeholder="Muelle">
    <input id="responsable" placeholder="Responsable">
  </div>

  <button onclick="registrar()">Guardar registro</button>
  <button onclick="exportarExcel()">üì• Exportar Excel</button>
  <button onclick="abrirDashboard()" style="
  margin-top:15px;
  background:var(--secondary);
  border:none;
  color:#fff;
  padding:12px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;">
  üìä Dashboard
</button>
</div>
<h2>üîç Filtros</h2>

  <div class="grid">
    <input id="f-fecha" type="date">
    <input id="f-transportadora" placeholder="Transportadora">
    <input id="f-producto" placeholder="Producto">
    <input id="f-placa" placeholder="Placa">
  </div>

  <button onclick="aplicarFiltros()">Aplicar filtros</button>
  <button onclick="limpiarFiltros()" style="background:#64748b;">Limpiar</button>
</div>

</div>

<!-- DASHBOARD -->
<div id="dashboard" class="dashboard">
  <div class="dashboard-card">
    <h4>Total Registros</h4>
    <span id="m-total">0</span>
  </div>

  <div class="dashboard-card">
    <h4>Tiempo Promedio</h4>
    <span id="m-promedio">--</span>
  </div>

  <div class="dashboard-card">
    <h4>Tiempo M√°ximo</h4>
    <span id="m-max">--</span>
  </div>

  <div class="dashboard-card">
    <h4>Tiempo M√≠nimo</h4>
    <span id="m-min">--</span>
  </div>
</div>

<!-- TABLA -->
<div class="card">
  <h2>üìã Registros</h2>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Fecha</th>
          <th>Transportadora</th>
          <th>Conductor</th>
          <th>Placa</th>
          <th>Producto</th>
          <th>Operaci√≥n</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Tiempo</th>
          <th>Muelle</th>
          <th>Responsable</th>
          <th>Observaciones</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody id="tabla"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwaNPotmMQcXYXx1Q0muTeowOrg-fMzXO3nWwp6nKOPfokgCAJQLOrZPX86JCzVFycx/exec";

function exportarExcel(){
  fetch(API_URL)
    .then(r=>r.json())
    .then(data=>{
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Datos");
      XLSX.writeFile(wb, "Control_Logistico.xlsx");
    });
}
function abrirDashboard(){
  window.open("dashboard.html", "_blank");
}

function actualizarDashboard(data){
  const tiempos = data.map(r=>r.Minutos).filter(t=>t);

  document.getElementById("m-total").innerText = data.length;
  if(!tiempos.length) return;

  const segundos = tiempos.map(t=>{
    const n = t.match(/\d+/g).map(Number);
    return n[0]*3600 + n[1]*60 + n[2];
  });

  const avg = Math.floor(segundos.reduce((a,b)=>a+b,0)/segundos.length);
  const f=s=>{
    const h=Math.floor(s/3600);s%=3600;
    const m=Math.floor(s/60);const ss=s%60;
    return `${h} HH ${m.toString().padStart(2,"0")} MM ${ss.toString().padStart(2,"0")} SS`;
  };

  document.getElementById("m-promedio").innerText=f(avg);
  document.getElementById("m-max").innerText=f(Math.max(...segundos));
  document.getElementById("m-min").innerText=f(Math.min(...segundos));
}

function registrar(){
  if(!fecha.value||!transportadora.value||!operacion.value||!inicio.value){
    alert("‚ö†Ô∏è Complete los campos obligatorios");
    return;
  }

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      fecha:fecha.value,
      transportadora:transportadora.value.toUpperCase(),
      conductor:conductor.value.toUpperCase(),
      placa:placa.value.toUpperCase(),
      producto:producto.value.toUpperCase(),
      operacion:operacion.value,
      inicio:inicio.value,
      fin:"",
      minutos:"",
      muelle:muelle.value.toUpperCase(),
      responsable:responsable.value.toUpperCase(),
      observaciones:""
    })
  }).then(()=>{limpiar();cargar();});
}

function limpiar(){
  document.querySelectorAll("input,select").forEach(e=>e.value="");
}

function cargar(){
  fetch(API_URL).then(r=>r.json()).then(data=>{
    tabla.innerHTML="";
    data.forEach((r,i)=>{
      tabla.innerHTML+=`
<tr id="fila-${i}">
<td>${i+1}</td>
<td>${r.Fecha||""}</td>
<td>${r.Transportadora||""}</td>
<td>${r.Conductor||""}</td>
<td>${r.Placa||""}</td>
<td>${r.Producto||""}</td>
<td>${r.Operacion||""}</td>
<td>${r.Inicio||""}</td>
<td>
  <input type="time"
  value="${r.Fin || ""}"
  ${r.Fin ? "disabled" : ""}
  onchange="actualizarFin(${i}, this.value)">

</td>

<td id="min-${i}">${r.Minutos||""}</td>
<td>${r.Muelle||""}</td>
<td>${r.Responsable||""}</td>
<td>
  <textarea
  ${r.Observaciones ? "disabled" : ""}
  onblur="actualizarObs(${i}, this.value)">
${r.Observaciones || ""}
</textarea>

</td>

<td><button class="btn-delete" onclick="eliminar(${i})">üóëÔ∏è</button></td>
</tr>`;
    });
    actualizarDashboard(data);
  });
   fetch(API_URL)
    .then(r=>r.json())
    .then(data=>{
      datosOriginales = data;
      datosFiltrados = data;
      renderTabla(data);
      actualizarDashboard(data);
    });
}
function renderTabla(data){
  tabla.innerHTML = "";

  data.forEach((r,i)=>{
    tabla.innerHTML += `
<tr id="fila-${i}">
<td>${i+1}</td>
<td>${r.Fecha||""}</td>
<td>${r.Transportadora||""}</td>
<td>${r.Conductor||""}</td>
<td>${r.Placa||""}</td>
<td>${r.Producto||""}</td>
<td>${r.Operacion||""}</td>

<td>${r.Inicio||""}</td>

<td>
  <input type="time"
    value="${r.Fin || ""}"
    ${r.Fin ? "disabled" : ""}
    onchange="actualizarFin(${i}, this.value)">
</td>

<td id="min-${i}">${r.Minutos||""}</td>
<td>${r.Muelle||""}</td>
<td>${r.Responsable||""}</td>

<td>
  <textarea
    ${r.Observaciones ? "disabled" : ""}
    onblur="actualizarObs(${i}, this.value)">
${r.Observaciones || ""}
  </textarea>
</td>

<td>
  <button class="btn-delete" onclick="eliminar(${i})">üóëÔ∏è</button>
</td>
</tr>`;
  });
}
function aplicarFiltros(){
  const fFecha = document.getElementById("f-fecha").value;
  const fTransportadora = document.getElementById("f-transportadora").value.toUpperCase();
  const fProducto = document.getElementById("f-producto").value.toUpperCase();
  const fPlaca = document.getElementById("f-placa").value.toUpperCase();

  datosFiltrados = datosOriginales.filter(r=>{
    return (
      (!fFecha || r.Fecha === fFecha) &&
      (!fTransportadora || (r.Transportadora||"").includes(fTransportadora)) &&
      (!fProducto || (r.Producto||"").includes(fProducto)) &&
      (!fPlaca || (r.Placa||"").includes(fPlaca))
    );
  });

  renderTabla(datosFiltrados);
  actualizarDashboard(datosFiltrados);
}
function limpiarFiltros(){
  document.getElementById("f-fecha").value="";
  document.getElementById("f-transportadora").value="";
  document.getElementById("f-producto").value="";
  document.getElementById("f-placa").value="";

  datosFiltrados = datosOriginales;
  renderTabla(datosOriginales);
  actualizarDashboard(datosOriginales);
}

function actualizarFin(i,fin){
  fetch(API_URL).then(r=>r.json()).then(data=>{
    const inicio=data[i].Inicio;
    const [hi,mi]=inicio.split(":").map(Number);
    const [hf,mf]=fin.split(":").map(Number);

    let d=(hf*3600+mf*60)-(hi*3600+mi*60);
    if(d<0) return alert("Hora fin inv√°lida");

    const h=Math.floor(d/3600);d%=3600;
    const m=Math.floor(d/60);const s=d%60;

    const t=`${h} HH ${m.toString().padStart(2,"0")} MM ${s.toString().padStart(2,"0")} SS`;
    document.getElementById(`min-${i}`).innerText=t;

    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        action:"update",
        index:i,
        fin:fin,
        minutos:t
      })
    }).then(()=>{
      // üîí BLOQUEAR EL INPUT FIN
      document.querySelector(`#fila-${i} input[type="time"]`).disabled = true;
    });
  });
}


function actualizarObs(i,t){
  if(!t.trim()) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"updateObs",
      index:i,
      observaciones:t.toUpperCase()
    })
  }).then(()=>{
    // üîí BLOQUEAR EL TEXTAREA
    document.querySelector(`#fila-${i} textarea`).disabled = true;
  });
}


function eliminar(i){
  if(prompt("Clave admin:")!=="Admin123")return;
  fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delete",index:i})})
  .then(()=>document.getElementById(`fila-${i}`).remove());
}

window.onload=cargar;
// üîÑ Sincronizaci√≥n autom√°tica cada 5 segundos
setInterval(()=>{
  fetch(API_URL)
    .then(r=>r.json())
    .then(data=>{
      datosOriginales = data;
      aplicarFiltros(); // üî• reaplica filtros activos
    });
},30000);


let datosOriginales = [];
let datosFiltrados = [];

</script>

</body>
</html>



